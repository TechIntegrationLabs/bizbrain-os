<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BizBrain OS - Voice Input</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='8' fill='%2310B981'/><text x='16' y='22' font-size='18' text-anchor='middle' fill='white' font-family='system-ui'>&#127908;</text></svg>">
  <style>
    :root {
      --color-primary: #3B82F6;
      --color-accent: #10B981;
      --color-red: #EF4444;
      --bg-body: #F8FAFC;
      --bg-card: #FFFFFF;
      --text-primary: #0F172A;
      --text-secondary: #475569;
      --text-tertiary: #94A3B8;
      --border-color: #E2E8F0;
      --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, sans-serif;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-body: #0B1120;
        --bg-card: #151D2E;
        --text-primary: #E2E8F0;
        --text-secondary: #94A3B8;
        --text-tertiary: #64748B;
        --border-color: #1E293B;
      }
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-sans);
      background: var(--bg-body);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      -webkit-font-smoothing: antialiased;
    }

    .voice-container {
      width: 100%;
      max-width: 640px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 32px;
    }

    /* Header */
    .voice-header {
      text-align: center;
    }

    .voice-header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }

    .voice-header p {
      font-size: 0.9375rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    /* Mode Toggle */
    .mode-toggle {
      display: flex;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 100px;
      padding: 4px;
      gap: 2px;
    }

    .mode-btn {
      padding: 8px 20px;
      border: none;
      background: transparent;
      border-radius: 100px;
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text-tertiary);
      cursor: pointer;
      font-family: var(--font-sans);
      transition: all 200ms ease;
    }

    .mode-btn.active {
      background: var(--color-primary);
      color: white;
      box-shadow: 0 2px 8px rgba(59,130,246,0.3);
    }

    /* Mic Button */
    .mic-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      position: relative;
    }

    .mic-ring {
      position: absolute;
      width: 160px;
      height: 160px;
      border-radius: 50%;
      border: 2px solid var(--border-color);
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      transition: all 300ms ease;
      pointer-events: none;
    }

    .mic-ring.active {
      border-color: var(--color-accent);
      animation: mic-pulse 1.5s ease-in-out infinite;
    }

    .mic-ring-outer {
      position: absolute;
      width: 200px;
      height: 200px;
      border-radius: 50%;
      border: 1px solid transparent;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }

    .mic-ring-outer.active {
      border-color: rgba(16,185,129,0.2);
      animation: mic-pulse-outer 1.5s ease-in-out infinite;
    }

    .mic-btn {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, var(--color-primary), #818CF8);
      color: white;
      font-size: 2.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 250ms cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 8px 32px rgba(59,130,246,0.3);
      position: relative;
      z-index: 2;
      user-select: none;
      -webkit-user-select: none;
    }

    .mic-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 12px 40px rgba(59,130,246,0.4);
    }

    .mic-btn:active {
      transform: scale(0.98);
    }

    .mic-btn.recording {
      background: linear-gradient(135deg, var(--color-accent), #34D399);
      box-shadow: 0 8px 32px rgba(16,185,129,0.4);
      animation: breathe 2s ease-in-out infinite;
    }

    .mic-btn.recording:hover {
      box-shadow: 0 12px 40px rgba(16,185,129,0.5);
    }

    .mic-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-top: 8px;
    }

    .mic-label.recording {
      color: var(--color-accent);
    }

    /* Audio Level Indicator */
    .level-bar-container {
      display: flex;
      align-items: center;
      gap: 3px;
      height: 32px;
    }

    .level-bar {
      width: 4px;
      height: 8px;
      background: var(--border-color);
      border-radius: 2px;
      transition: height 100ms ease, background 200ms ease;
    }

    .level-bar.active {
      background: var(--color-accent);
    }

    /* Transcript Display */
    .transcript-area {
      width: 100%;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
    }

    .transcript-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .transcript-label {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-tertiary);
    }

    .transcript-actions {
      display: flex;
      gap: 4px;
    }

    .transcript-btn {
      padding: 4px 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-body);
      color: var(--text-secondary);
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      font-family: var(--font-sans);
      transition: all 150ms ease;
    }

    .transcript-btn:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }

    .transcript-body {
      padding: 16px;
      min-height: 120px;
      max-height: 320px;
      overflow-y: auto;
      font-size: 1rem;
      line-height: 1.7;
      color: var(--text-primary);
    }

    .transcript-body .interim {
      color: var(--text-tertiary);
      font-style: italic;
    }

    .transcript-body .empty {
      color: var(--text-tertiary);
      font-style: italic;
      text-align: center;
      padding: 24px 0;
    }

    .transcript-body .sent {
      color: var(--color-accent);
      font-size: 0.75rem;
      display: block;
      margin-top: 4px;
    }

    /* Status */
    .status-text {
      font-size: 0.8125rem;
      color: var(--text-tertiary);
      text-align: center;
    }

    .status-text.error {
      color: var(--color-red);
    }

    /* Unsupported Fallback */
    .unsupported {
      text-align: center;
      padding: 48px 24px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
    }

    .unsupported h2 {
      margin-bottom: 12px;
    }

    .unsupported p {
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    /* Back link */
    .back-link {
      position: fixed;
      top: 16px;
      left: 16px;
      padding: 8px 16px;
      border-radius: 8px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      font-size: 0.8125rem;
      font-weight: 500;
      text-decoration: none;
      transition: all 150ms ease;
      font-family: var(--font-sans);
    }

    .back-link:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }

    /* Animations */
    @keyframes mic-pulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      50% { transform: translate(-50%, -50%) scale(1.08); opacity: 0.6; }
    }

    @keyframes mic-pulse-outer {
      0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.5; }
      50% { transform: translate(-50%, -50%) scale(1.12); opacity: 0.2; }
    }

    @keyframes breathe {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.03); }
    }

    /* Scrollbar */
    .transcript-body::-webkit-scrollbar { width: 6px; }
    .transcript-body::-webkit-scrollbar-track { background: transparent; }
    .transcript-body::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
  </style>
</head>
<body>
  <a href="/" class="back-link">&larr; Dashboard</a>

  <div class="voice-container" id="app">
    <!-- Populated by script -->
  </div>

  <script>
  (function () {
    'use strict';

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const app = document.getElementById('app');

    if (!SpeechRecognition) {
      app.innerHTML = `
        <div class="unsupported">
          <h2>Speech Recognition Not Available</h2>
          <p>Your browser does not support the Web Speech API.</p>
          <p>Please use <strong>Google Chrome</strong> or <strong>Microsoft Edge</strong> for voice input.</p>
          <p style="margin-top:16px"><a href="/" style="color:var(--color-primary);">&larr; Return to Dashboard</a></p>
        </div>`;
      return;
    }

    let mode = 'push'; // 'push' or 'continuous'
    let isRecording = false;
    let recognition = null;
    let fullTranscript = '';
    let interimText = '';
    let sendQueue = [];

    // --- Render ---
    function render() {
      app.innerHTML = `
        <div class="voice-header">
          <h1>Voice Input</h1>
          <p>Speak naturally. Your words are being transcribed and sent to Claude Code.</p>
        </div>

        <div class="mode-toggle">
          <button class="mode-btn ${mode === 'push' ? 'active' : ''}" data-mode="push">Push to Talk</button>
          <button class="mode-btn ${mode === 'continuous' ? 'active' : ''}" data-mode="continuous">Continuous</button>
        </div>

        <div class="mic-area">
          <div class="mic-ring ${isRecording ? 'active' : ''}" id="mic-ring"></div>
          <div class="mic-ring-outer ${isRecording ? 'active' : ''}" id="mic-ring-outer"></div>
          <button class="mic-btn ${isRecording ? 'recording' : ''}" id="mic-btn">
            ${isRecording ? '&#9632;' : '&#127908;'}
          </button>
        </div>
        <div class="mic-label ${isRecording ? 'recording' : ''}">
          ${isRecording ? 'Listening...' : (mode === 'push' ? 'Click to start' : 'Click to start continuous')}
        </div>

        <div class="level-bar-container" id="level-bars">
          ${Array.from({ length: 24 }, () => '<div class="level-bar"></div>').join('')}
        </div>

        <div class="transcript-area">
          <div class="transcript-header">
            <span class="transcript-label">Transcript</span>
            <div class="transcript-actions">
              <button class="transcript-btn" id="btn-copy">Copy</button>
              <button class="transcript-btn" id="btn-send">Send to Brain</button>
              <button class="transcript-btn" id="btn-clear">Clear</button>
            </div>
          </div>
          <div class="transcript-body" id="transcript">
            ${fullTranscript
              ? fullTranscript + (interimText ? `<span class="interim">${escapeHtml(interimText)}</span>` : '')
              : '<div class="empty">Your transcription will appear here...</div>'}
          </div>
        </div>

        <div class="status-text" id="status">Ready</div>`;

      bindEvents();
    }

    function bindEvents() {
      // Mode buttons
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          if (isRecording) stopRecording();
          mode = btn.dataset.mode;
          render();
        });
      });

      // Mic button
      const micBtn = document.getElementById('mic-btn');
      if (mode === 'push') {
        micBtn.addEventListener('mousedown', startRecording);
        micBtn.addEventListener('mouseup', stopRecording);
        micBtn.addEventListener('mouseleave', () => { if (isRecording) stopRecording(); });
        micBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startRecording(); });
        micBtn.addEventListener('touchend', (e) => { e.preventDefault(); stopRecording(); });
      } else {
        micBtn.addEventListener('click', () => {
          if (isRecording) stopRecording();
          else startRecording();
        });
      }

      // Transcript buttons
      document.getElementById('btn-copy')?.addEventListener('click', copyTranscript);
      document.getElementById('btn-send')?.addEventListener('click', sendTranscript);
      document.getElementById('btn-clear')?.addEventListener('click', clearTranscript);
    }

    // --- Recognition ---
    function startRecording() {
      if (isRecording) return;
      isRecording = true;

      recognition = new SpeechRecognition();
      recognition.continuous = mode === 'continuous';
      recognition.interimResults = true;
      recognition.lang = 'en-US';
      recognition.maxAlternatives = 1;

      recognition.onresult = (event) => {
        let interim = '';
        let final = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            final += transcript + ' ';
          } else {
            interim += transcript;
          }
        }

        if (final) {
          fullTranscript += escapeHtml(final);
          sendToBuffer(final.trim());
        }
        interimText = interim;
        updateTranscript();
        animateLevels(true);
      };

      recognition.onend = () => {
        if (isRecording && mode === 'continuous') {
          // Restart in continuous mode
          try { recognition.start(); } catch (_) {}
        } else {
          isRecording = false;
          animateLevels(false);
          render();
        }
      };

      recognition.onerror = (event) => {
        const status = document.getElementById('status');
        if (status) {
          status.className = 'status-text error';
          status.textContent = `Error: ${event.error}`;
        }
        if (event.error !== 'no-speech') {
          isRecording = false;
          render();
        }
      };

      try {
        recognition.start();
        render();
        setStatus('Listening...');
      } catch (err) {
        isRecording = false;
        setStatus('Failed to start: ' + err.message, true);
        render();
      }
    }

    function stopRecording() {
      if (!isRecording) return;
      isRecording = false;
      if (recognition) {
        try { recognition.stop(); } catch (_) {}
      }
      animateLevels(false);
      render();
      setStatus('Stopped');
    }

    function updateTranscript() {
      const el = document.getElementById('transcript');
      if (!el) return;
      if (!fullTranscript && !interimText) {
        el.innerHTML = '<div class="empty">Your transcription will appear here...</div>';
      } else {
        el.innerHTML = fullTranscript + (interimText ? `<span class="interim">${escapeHtml(interimText)}</span>` : '');
        el.scrollTop = el.scrollHeight;
      }
    }

    // --- Audio Level Animation ---
    let levelInterval = null;
    function animateLevels(active) {
      const bars = document.querySelectorAll('.level-bar');
      if (!active) {
        clearInterval(levelInterval);
        levelInterval = null;
        bars.forEach(b => { b.style.height = '8px'; b.classList.remove('active'); });
        return;
      }
      if (levelInterval) return;
      levelInterval = setInterval(() => {
        bars.forEach(b => {
          const h = Math.random() * 24 + 4;
          b.style.height = h + 'px';
          b.classList.toggle('active', h > 12);
        });
      }, 100);
    }

    // --- Send to server (Tauri or HTTP) ---
    const isTauri = !!(window.__TAURI__ || window.__TAURI_INTERNALS__);

    async function sendToBuffer(text) {
      if (!text) return;
      try {
        if (isTauri && window.__TAURI__?.core?.invoke) {
          await window.__TAURI__.core.invoke('write_voice_buffer', { text });
        } else {
          await fetch('/api/voice-buffer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text }),
          });
        }
      } catch (err) {
        console.error('Failed to send to buffer:', err);
      }
    }

    async function sendTranscript() {
      const text = stripHtml(fullTranscript).trim();
      if (!text) return;
      try {
        if (isTauri && window.__TAURI__?.core?.invoke) {
          await window.__TAURI__.core.invoke('write_voice_buffer', { text: '[FULL TRANSCRIPT] ' + text });
        } else {
          await fetch('/api/voice-buffer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: '[FULL TRANSCRIPT] ' + text }),
          });
        }
        setStatus('Transcript sent to Brain');
      } catch (err) {
        setStatus('Failed to send: ' + err.message, true);
      }
    }

    function copyTranscript() {
      const text = stripHtml(fullTranscript).trim();
      if (!text) return;
      navigator.clipboard.writeText(text).then(() => {
        setStatus('Copied to clipboard');
      }).catch(() => {
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        setStatus('Copied to clipboard');
      });
    }

    function clearTranscript() {
      fullTranscript = '';
      interimText = '';
      updateTranscript();
      setStatus('Cleared');
    }

    // --- Helpers ---
    function setStatus(text, isError = false) {
      const el = document.getElementById('status');
      if (!el) return;
      el.className = `status-text${isError ? ' error' : ''}`;
      el.textContent = text;
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = String(str || '');
      return div.innerHTML;
    }

    function stripHtml(html) {
      const div = document.createElement('div');
      div.innerHTML = html;
      return div.textContent || '';
    }

    // --- Init ---
    render();
  })();
  </script>
</body>
</html>
